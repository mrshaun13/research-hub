name: Validate Research Project PR

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Detect new/changed projects
        id: detect
        run: |
          # Compare PR branch against base (main)
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- 'src/projects/')

          # Extract unique project slugs from changed file paths
          SLUGS=$(echo "$CHANGED_FILES" | grep -oP 'src/projects/\K[^/]+' | sort -u | grep -v '^index\.js$' || true)

          if [ -z "$SLUGS" ]; then
            echo "No project changes detected in this PR."
            echo "has_projects=false" >> $GITHUB_OUTPUT
          else
            echo "Detected projects:"
            echo "$SLUGS"
            # Convert to space-separated for CLI args
            SLUG_ARGS=$(echo "$SLUGS" | tr '\n' ' ')
            echo "slugs=$SLUG_ARGS" >> $GITHUB_OUTPUT
            echo "has_projects=true" >> $GITHUB_OUTPUT
            echo "count=$(echo "$SLUGS" | wc -l | tr -d ' ')" >> $GITHUB_OUTPUT
          fi

      - name: Validate project structure & metadata
        id: validate
        if: steps.detect.outputs.has_projects == 'true'
        run: |
          node .github/scripts/validate-research-project.mjs ${{ steps.detect.outputs.slugs }}
        continue-on-error: true

      - name: Build test
        id: build
        if: steps.detect.outputs.has_projects == 'true'
        run: |
          npm ci
          npx vite build 2>&1 | tail -20
        continue-on-error: true

      - name: Post validation report as PR comment
        if: steps.detect.outputs.has_projects == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the validation report
            let validationReport = '';
            try {
              validationReport = fs.readFileSync('validation-report.md', 'utf-8');
            } catch {
              validationReport = 'âš ï¸ Validation report not generated.';
            }

            // Build status
            const buildPassed = '${{ steps.build.outcome }}' === 'success';
            const validatePassed = '${{ steps.validate.outcome }}' === 'success';

            let body = validationReport + '\n\n';
            body += '## ğŸ—ï¸ Build Test\n\n';
            body += buildPassed
              ? 'âœ… `vite build` completed successfully\n'
              : 'âŒ `vite build` failed â€” project has compilation errors\n';

            body += '\n---\n\n';

            if (validatePassed && buildPassed) {
              body += '### âœ… All checks passed â€” this PR is ready for review\n';
            } else {
              body += '### âŒ Some checks failed â€” please review the issues above\n';
            }

            body += `\n<sub>Validated ${new Date().toISOString()} Â· ${{ steps.detect.outputs.count }} project(s) Â· commit ${{ github.event.pull_request.head.sha }}</sub>`;

            // Find existing bot comment to update (avoid spam)
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Research Project Validation Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Apply labels
        if: steps.detect.outputs.has_projects == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const validatePassed = '${{ steps.validate.outcome }}' === 'success';
            const buildPassed = '${{ steps.build.outcome }}' === 'success';

            const labelsToAdd = [];
            const labelsToRemove = [];

            if (validatePassed && buildPassed) {
              labelsToAdd.push('validated');
              labelsToRemove.push('validation-failed');
            } else {
              labelsToAdd.push('validation-failed');
              labelsToRemove.push('validated');
            }

            // Add labels
            if (labelsToAdd.length > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: labelsToAdd,
                });
              } catch (e) {
                console.log(`Note: Could not add labels (${e.message}). Labels may need to be created first.`);
              }
            }

            // Remove stale labels
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label,
                });
              } catch {
                // Label wasn't present â€” that's fine
              }
            }

      - name: Set final status
        if: steps.detect.outputs.has_projects == 'true'
        run: |
          VALIDATE="${{ steps.validate.outcome }}"
          BUILD="${{ steps.build.outcome }}"

          if [ "$VALIDATE" = "success" ] && [ "$BUILD" = "success" ]; then
            echo "âœ… All validation checks passed"
            exit 0
          else
            echo "âŒ Validation failed (validate=$VALIDATE, build=$BUILD)"
            exit 1
          fi

      - name: Skip â€” no project changes
        if: steps.detect.outputs.has_projects != 'true'
        run: |
          echo "â„¹ï¸ No research project changes detected in this PR. Skipping validation."
          echo "## â„¹ï¸ No Research Projects Detected" >> $GITHUB_STEP_SUMMARY
          echo "This PR does not add or modify any research projects under \`src/projects/\`." >> $GITHUB_STEP_SUMMARY
