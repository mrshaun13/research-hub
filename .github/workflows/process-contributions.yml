name: Process Community Contributions

on:
  push:
    branches: [agent-contributions]

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect new projects
        id: detect
        run: |
          # Find project directories added vs main
          NEW_PROJECTS=$(git diff --name-only origin/main...HEAD -- 'src/projects/*/App.jsx' | sed 's|src/projects/||;s|/App.jsx||' | sort -u)

          if [ -z "$NEW_PROJECTS" ]; then
            echo "No new projects detected."
            echo "has_projects=false" >> $GITHUB_OUTPUT
          else
            echo "New projects detected:"
            echo "$NEW_PROJECTS"
            echo "has_projects=true" >> $GITHUB_OUTPUT

            # Build PR title and body from project names
            COUNT=$(echo "$NEW_PROJECTS" | wc -l | tr -d ' ')
            echo "count=$COUNT" >> $GITHUB_OUTPUT

            if [ "$COUNT" -eq 1 ]; then
              TITLE="Community contribution: $NEW_PROJECTS"
            else
              TITLE="Community contribution: $COUNT new research projects"
            fi
            echo "title=$TITLE" >> $GITHUB_OUTPUT

            # Build body with project list
            BODY="## New Research Projects\n\n"
            for PROJECT in $NEW_PROJECTS; do
              BODY="${BODY}- \`${PROJECT}\`\n"
            done
            BODY="${BODY}\n**Pushed by:** ${{ github.actor }}\n**Commit:** \`${{ github.sha }}\`\n\n---\n_Auto-created from \`agent-contributions\` branch. The validate-pr workflow will run full validation checks automatically._"

            # Use a delimiter for multiline output
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo -e "$BODY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

          echo "### New projects detected:" >> $GITHUB_STEP_SUMMARY
          echo "$NEW_PROJECTS" >> $GITHUB_STEP_SUMMARY

      - name: Check for existing PR
        id: existing
        if: steps.detect.outputs.has_projects == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:agent-contributions`,
              base: 'main',
              state: 'open',
            });
            if (prs.length > 0) {
              core.setOutput('exists', 'true');
              core.setOutput('pr_number', prs[0].number);
              console.log(`Existing PR #${prs[0].number} found â€” it will be updated automatically.`);
            } else {
              core.setOutput('exists', 'false');
              console.log('No existing PR found â€” will create one.');
            }

      - name: Create PR
        if: steps.detect.outputs.has_projects == 'true' && steps.existing.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${{ steps.detect.outputs.title }}`,
              body: `${{ steps.detect.outputs.body }}`,
              head: 'agent-contributions',
              base: 'main',
            });
            console.log(`Created PR #${pr.number}: ${pr.html_url}`);

            // Add a label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['community-contribution'],
              });
            } catch (e) {
              console.log(`Note: Could not add label (${e.message}).`);
            }

      - name: Update existing PR
        if: steps.detect.outputs.has_projects == 'true' && steps.existing.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.existing.outputs.pr_number || 0 }};
            if (prNumber > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ðŸ”„ New push to \`agent-contributions\` detected.\n\n${{ steps.detect.outputs.body }}\n\nValidation will re-run automatically.`,
              });
              console.log(`Updated PR #${prNumber} with new comment.`);
            }

      - name: Summary
        if: always()
        run: |
          echo "## Community Contribution Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** agent-contributions" >> $GITHUB_STEP_SUMMARY
          echo "**Projects:** ${{ steps.detect.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pushed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
